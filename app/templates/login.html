{% extends 'base.html' %}

{% block title %}Login - NJIT Global Explorer{% endblock %}

{% block additional_styles %}
    <link rel="stylesheet" href="static/css/login_styles.css">
{% endblock %}

{% block content %}
<div class="container">
    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn">&times;</span>
            <button id="googleSignInButton" class="google-button">
                <img src="https://img.icons8.com/color/16/000000/google-logo.png" alt="Google logo" class="google-logo">
                Continue with Google
            </button>
            <a href="#" class="help-link">Need help?</a>
        </div>
    </div>
</div>
{% endblock %}
{% block additional_scripts %}
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyB47Ok4IVtyUHLC8XEdENxgwCQ46dteh2U",
    authDomain: "njitglobalexplorer.firebaseapp.com",
    projectId: "njitglobalexplorer",
    storageBucket: "njitglobalexplorer.appspot.com",
    messagingSenderId: "112642921550",
    appId: "1:112642921550:web:87e3928730ec7c8987df1f",
    measurementId: "G-PN7RTPMT4L"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth();

  document.getElementById('googleSignInButton').addEventListener('click', () => {
    const provider = new GoogleAuthProvider();
    provider.addScope('https://www.googleapis.com/auth/userinfo.email');
    provider.addScope('https://www.googleapis.com/auth/userinfo.profile');
    provider.setCustomParameters({
      'login_hint': 'user@example.com'
    });
    signInWithRedirect(auth, provider);
  });

  const previousUrl = "{{ previous_url | default(url_for('index')) }}"; // Default to the root URL if previous_url is not provided

  document.addEventListener("DOMContentLoaded", function () {
    const popup = document.getElementById("popup");
    const closeBtn = document.querySelector(".close-btn");

    // Functionality to close the popup and redirect to the previous page
    closeBtn.addEventListener("click", function () {
      window.location.href = previousUrl;
    });

    // Optionally, close the popup when clicking outside of it and redirect to the previous page
    document.addEventListener("click", function (event) {
      if (event.target === popup) {
        window.location.href = previousUrl;
      }
    });

    // Capture the info returned by the redirect
    getRedirectResult(auth)
      .then((result) => {
        if (result) {
          const user = result.user;
          console.log('User info:', user);
          // You can handle the user info here, e.g., send it to your server
        }
      })
      .catch((error) => {
        console.error('Error during sign-in redirect:', error);
      });
  });
</script>
{% endblock %}